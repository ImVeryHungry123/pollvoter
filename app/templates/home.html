{% extends 'base.html' %}
{% block title %}Home - Pollvoter{% endblock %}

{% block content %}

<div class="dashboard-layout">
    
    <aside class="sidebar">
        
        <div class="sidebar-widget">
            <h3 class="widget-title">
                <i class="fa-solid fa-wand-magic-sparkles" style="color: var(--primary);"></i> Create a Poll
            </h3>
            
            <form action="{{ url_for('polls.create_poll') }}" method="POST" id="sidebar-poll-form">
                
                <div style="margin-bottom: 10px;">
                    <input type="text" name="title" placeholder="What's your question?" required maxlength="40" 
                           style="background: var(--bg-body); border: 1px solid var(--border-subtle); width: 100%; padding: 10px; border-radius: 8px; color: var(--text-main);">
                </div>

                <div style="margin-bottom: 15px;">
                    <textarea name="description" placeholder="Description (optional)" rows="2" maxlength="70"
                              style="background: var(--bg-body); border: 1px solid var(--border-subtle); width: 100%; padding: 10px; border-radius: 8px; color: var(--text-main); resize: none;"></textarea>
                </div>

                <div id="sidebar-options">
                    <div style="position: relative; margin-bottom: 8px;">
                        <span style="position: absolute; left: 10px; top: 10px; font-size: 0.8rem; color: var(--text-muted);">1</span>
                        <input type="text" name="options" placeholder="Option 1" required maxlength="25"
                               style="background: var(--bg-body); border: 1px solid var(--border-subtle); width: 100%; padding: 8px 8px 8px 30px; border-radius: 8px; color: var(--text-main);">
                    </div>
                    <div style="position: relative; margin-bottom: 8px;">
                        <span style="position: absolute; left: 10px; top: 10px; font-size: 0.8rem; color: var(--text-muted);">2</span>
                        <input type="text" name="options" placeholder="Option 2" required maxlength="25"
                               style="background: var(--bg-body); border: 1px solid var(--border-subtle); width: 100%; padding: 8px 8px 8px 30px; border-radius: 8px; color: var(--text-main);">
                    </div>
                </div>

                <button type="button" id="sidebar-add-btn" class="btn btn-outline" 
                        style="width: 100%; border-style: dashed; margin-bottom: 15px; font-size: 0.85rem; color: var(--text-muted);">
                    + Add Option
                </button>

                <button type="submit" class="btn btn-primary" style="width: 100%; font-weight: bold;">Create Poll</button>
            </form>
        </div>

        <div class="sidebar-widget">
            <h3 class="widget-title">People to Follow</h3>
            
            {% if suggestions %}
                {% for user in suggestions %}
                <div class="user-row" style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-subtle);">
                    <img src="{{ user.getpfp() }}" alt="{{ user.username }}" class="avatar-sm">
                    
                    <div style="flex-grow: 1; margin-left: 10px; overflow: hidden;">
                        <a href="{{ url_for('main.user_profile', username=user.username) }}" style="font-weight: bold; font-size: 0.9rem; display: block; text-overflow: ellipsis; overflow: hidden;">
                            {{ user.username }}
                        </a>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">
                            @{{ user.username|lower }}
                        </div>
                    </div>
                    
                    <a href="{{ url_for('main.follow', username=user.username) }}" class="btn btn-sm btn-outline" style="padding: 4px 10px; font-size: 0.75rem;">
                        Follow
                    </a>
                </div>
                {% endfor %}
            {% else %}
                <p style="color: var(--text-muted); font-size: 0.9rem;">No new users to follow.</p>
            {% endif %}
        </div>
    </aside>

    <main class="feed">
        <div class="search-container" style="margin-bottom: 20px;">
    <form method="GET" action="{{ url_for('main.home') }}" style="display: flex; gap: 10px;">
        <input type="text" name="q" placeholder="Search polls..." value="{{ q if q else '' }}" class="form-control" style="flex: 1;">
        <button type="submit" class="btn btn-primary"><i class="fa-solid fa-magnifying-glass"></i> </button>
        {% if q %}
            <a href="{{ url_for('main.home') }}" class="btn btn-secondary">Clear</a>
        {% endif %}
    </form>
</div>

    {% if polls %}
        {% for poll in polls %}
            {# The loop content starts here but is cut off in the image #}
        {% endfor %}
    {% else %}
        <div style="text-align: center; margin-top: 50px; color: gray;">
            <h3>Nothing found for "{{ q }}"</h3>
            <p>Try searching for something else. <i class="fa-solid fa-magnifying-glass"></i> </p>
        </div>
    {% endif %}
        {% if current_user.is_authenticated %}
            <div style="margin-bottom: 20px;">
                <h2>Recent Polls <i class="fa-solid fa-clock"></i> </h2>
            </div>

            {% if polls %}
                {% for poll in polls %}
                <div class="poll-card">
                    <div class="user-row" style="border:none; margin-bottom: 15px; padding: 0;">
                        <img src="{{ poll.author.getpfp() }}" class="avatar-sm" alt="Author">
                        <div style="margin-left: 10px;">
                            <div style="font-weight: bold; font-size: 0.95rem;">
                                <a href="{{ url_for('main.user_profile', username=poll.author.username) }}">{{ poll.author.username }}</a>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">{{ poll.created_at.strftime('%b %d') }}</div>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 10px;">
                        <a href="{{ url_for('polls.poll_detail', poll_id=poll.id) }}" style="text-decoration: none; color: var(--text-main);">
                            {{ poll.title }}
                        </a>
                    </h3>
                    {% if poll.tags %}
                    <div class="poll-tags-container" style="margin-top: 15px; margin-bottom: 10px;">
                        {% for tag in poll.tags %}
                            <a href="{{ url_for('main.home', tag=tag.name) }}" class="tag-pill">
                                <i class="fa-solid fa-hashtag"></i> {{ tag.name }}
                            </a>
                        {% endfor %}
                    </div>
                        {% endif %}
                    {% if poll.description %}
                        
                        <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 15px;">{{ poll.description }}</p>
                    {% endif %}

                    <div class="poll-options-list" style="opacity: 0.9;">
                        {% for option in poll.options[:2] %}
                        <div style="border: 1px solid var(--border-subtle); padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; background: var(--bg-body); font-size: 0.9rem;">
                            {{ option.text }}
                        </div>
                        {% endfor %}
                        {% if poll.options|length > 2 %}
                            <div style="font-size: 0.8rem; color: var(--text-muted); text-align: center;">+ {{ poll.options|length - 2 }} more options</div>
                        {% endif %}
                    </div>
                                {% if poll.uploads %}
                    <div class="poll-attachments" style="margin-top: 25px;">
                        <h5 class="widget-title" style="margin-bottom: 15px;">
                            <i class="fa-solid fa-paperclip"></i> Contains Attachments
                        </h5>
                    </div>
                    {%endif%}
                    <div class="poll-meta-footer">
                        <div style="display: flex; gap: 15px; font-size: 0.85rem; color: var(--text-muted);">
                            <span><i class="fa-solid fa-square-poll-vertical"></i></i> {{ poll.getvotecount() }} votes</span>
                            <span><i class="fa-solid fa-message"></i></i> {{ poll.comments|length }} comments</span>
                        </div>
                        <a href="{{ url_for('polls.poll_detail', poll_id=poll.id) }}" class="btn btn-primary" style="padding: 6px 16px; font-size: 0.85rem;">Vote</a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="poll-card" style="text-align: center; padding: 3rem;">
                    <i class="fa-solid fa-layer-group" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 10px;"></i>
                    <p>No polls found.</p>
                </div>
            {% endif %}

        {% else %}
            <div class="card" style="text-align: center; padding: 4rem 2rem;">
                <h1 style="margin-bottom: 10px;">Welcome to Pollvoter!</h1>
                <p style="color: var(--text-muted); margin-bottom: 30px;">Join the community to create polls and vote on trending topics.</p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <a href="{{ url_for('auth.login') }}" class="btn btn-outline" style="min-width: 120px;">Login</a>
                    <a href="{{ url_for('auth.register') }}" class="btn btn-primary" style="min-width: 120px;">Register</a>
                </div>
            </div>
        {% endif %}
    </main>
</div>

<script>
    document.getElementById('sidebar-add-btn').addEventListener('click', function() {
        const container = document.getElementById('sidebar-options');
        const count = container.querySelectorAll('input').length + 1;
        
        if (count > 5) {
            alert("Limit reached for quick poll. Use full creator for more.");
            return;
        }

        const div = document.createElement('div');
        div.style.position = 'relative';
        div.style.marginBottom = '8px';
        
        // This is the number (1, 2, 3...)
        const span = document.createElement('span');
        span.style.position = 'absolute';
        span.style.left = '10px';
        span.style.top = '10px';
        span.style.fontSize = '0.8rem';
        span.style.color = 'var(--text-muted)';
        span.innerText = count;

        const input = document.createElement('input');
        input.type = 'text';
        input.name = 'options';
        input.placeholder = 'Option ' + count;
        input.required = true;
        input.maxLength = 25;
        // Copy exact styles from above
        input.style.background = 'var(--bg-body)';
        input.style.border = '1px solid var(--border-subtle)';
        input.style.width = '100%';
        input.style.padding = '8px 8px 8px 30px'; // padding-left accommodates the number
        input.style.borderRadius = '8px';
        input.style.color = 'var(--text-main)';
        
        div.appendChild(span);
        div.appendChild(input);
        container.appendChild(div);


    });
</script>

{% endblock %}