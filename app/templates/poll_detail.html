{% extends "base.html" %}

{% block title %}{{ poll.title }} - Poll{% endblock %}

{% block content %}
<div class="poll-detail">
    <div class="poll-card">
        <div class="poll-header">
            <h2>{{ poll.title }}</h2>
            <span class="poll-stats">
                <i class="fas fa-vote-yea"></i> {{ poll.getvotecount() }} votes
                <i class="fas fa-comments"></i> {{ poll.comments|length }} comments
            </span>
        </div>
        
        <div class="poll-author">
            <div class="user-avatar"><img src="{{ current_user.getpfp() }}" alt="Profile Picture" width="150" height="150"></div>
            <div>
                <div class="author-name">{{ poll.author.full_name if poll.author.full_name else poll.author.username  }}</div>
                <small class="poll-date">{{ poll.created_at.strftime('%d.%m.%Y  %H:%M') }}</small>
            </div>
        </div>
        
        {% if poll.description %}
        <p class="poll-description">{{ poll.description }}</p>
        {% endif %}
        
        <!-- Voting -->
        {% if user_vote %}
            <div class="voted-message">
                <p>You have already voted in this poll.</p>
            </div>
        {% else %}
            <form method="POST" action="{{ url_for('polls.vote', poll_id=poll.id) }}" class="vote-form">
                <div class="vote-options">
                    <button type="submit" name="vote" value="yes" class="btn btn-success vote-btn">Yes</button>
                    <button type="submit" name="vote" value="no" class="btn btn-danger vote-btn">No</button>
                </div>
            </form>
        {% endif %}
        
        <!-- Voting results -->
        <div class="vote-results">
            <h4>Results:</h4>
            <div class="vote-option">
                <span>Yes: {{ poll.getyescount() }} ({{ "%.1f"|format(poll.getyespercentage()) }}%)</span>
                <div class="progress-bar">
                    <div class="progress-fill yes-fill" style="width: {{ poll.getyespercentage() }}%"></div>
                </div>
            </div>
            <div class="vote-option">
                <span>No: {{ poll.getnocount() }} ({{ "%.1f"|format(poll.getnopercentage()) }}%)</span>
                <div class="progress-bar">
                    <div class="progress-fill no-fill" style="width: {{ poll.getnopercentage() }}%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="comments-section">
        <h3>Comments ({{ poll.comments|length }})</h3>
        
        <form method="POST" action="{{ url_for('polls.add_comment', poll_id=poll.id) }}" class="comment-form">
            <div class="form-group">
                <textarea name="content" placeholder="Leave a comment..." required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Add Comment</button>
        </form>
        
        <div class="comments-list">
            {% for comment in poll.comments|sort(attribute='created_at', reverse=true) %}
            <div class="comment">
                <div class="comment-header">
                    <div class="comment-author">
                        <div class="user-avatar small">{{ comment.author.username[0]|upper }}</div>
                        <strong>{{ comment.author.username }}</strong>
                    </div>
                    <small class="comment-date">{{ comment.created_at.strftime('%d.%m.%Y  %H:%M') }}</small>
                </div>
                <div class="comment-content">
                    {{ comment.content }}
                </div>
                {%if comment.author == current_user%}
                <button onclick="toggleEdit({{comment.id}})">Edit</button>
                {%endif%}
            </div>
            {% else %}
            <p class="no-comments">No comments yet. Be the first!</p>
            {% endfor %}
        </div>
    </div>
</div>
<script>
    function toggleEdit(commentId){
        const viewDiv = document.getElementById('comment-view-' + commentId)
        const editDiv = document.getElementById('comment-edit-' + commentId)

        if (viewDiv.style.display === 'none') {
            viewDiv.style.display = 'block';
            editDiv.style.display = 'none';
        } else {
            viewDiv.style.display = 'none';
            editDiv.style.display = 'block';
        }
    }
</script>
{% endblock %}
