{% extends "base.html" %}

{% block title %}{{ poll.title }} - Poll{% endblock %}

{% block content %}
<div class="poll-detail">
    <div class="poll-card">
        <div class="poll-header">
            <h2>{{ poll.title }}</h2>
            <span class="poll-stats">
                <i class="fas fa-vote-yea"></i> {{ poll.getvotecount() }} votes
                <i class="fas fa-comments"></i> {{ poll.comments|length }} comments
            </span>
        </div>
        
        <div class="poll-author">
            <div class="user-avatar"><img src="{{ current_user.getpfp() }}" alt="Profile Picture" width="150" height="150"></div>
            <div>
                <div class="author-name">{{ poll.author.full_name if poll.author.full_name else poll.author.username  }}</div>
                <small class="poll-date">{{ poll.created_at.strftime('%d.%m.%Y  %H:%M') }}</small>
            </div>
        </div>
        
        {% if poll.description %}
        <p class="poll-description">{{ poll.description }}</p>
        {% endif %}
        
        <!-- Voting -->
        {% if user_vote %}
            <div class="voted-message">
                <p>You have already voted. Your choice was: <strong>{{ user_vote.option.text }}</strong></p>
            </div>
        {% else %}
            <form method="POST" action="{{ url_for('polls.vote', poll_id=poll.id) }}" class="vote-form">
                <div class="vote-options">
                    {% for option in poll.options %}
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="option_id" id="option{{ option.id }}" value="{{ option.id }}" required>
                        <label class="form-check-label" for="option{{ option.id }}">
                            {{ option.text }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <button type="submit" class="btn btn-primary mt-3">Submit Vote</button>
            </form>
        {% endif %}

        <div class="vote-results">
            <h4>Results:</h4>
            {% set total_votes = poll.getvotecount() %}
            
            {% for option in poll.options %}
                {% set vote_count = option.votes|length %}
                {% set percentage = (vote_count / total_votes * 100) if total_votes > 0 else 0 %}
                
                <div class="vote-option">
                    <span>{{ option.text }}: {{ vote_count }} ({{ "%.1f"|format(percentage) }}%)</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ percentage }}%"></div>
                    </div>
                </div>
            {% endfor %}
        </div>
    
    <div class="comments-section">
        <h3>Comments ({{ poll.comments|length }})</h3>
        
        <form method="POST" action="{{ url_for('polls.add_comment', poll_id=poll.id) }}" class="comment-form">
            <div class="form-group">
                <textarea name="content" placeholder="Leave a comment..." required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Add Comment</button>
        </form>
        
<div class="comments-list">
    {% for comment in poll.comments|sort(attribute='created_at', reverse=true) %}
    
    {% if comment.author == current_user or (not current_user.is_blocking(comment.author) and not comment.author.is_blocking(current_user)) %}
    
    <div class="comment">
        <div class="comment-header">
            <div class="comment-author">
                <div class="user-avatar small"><img src="{{ comment.author.getpfp() }}" alt="PFP"></div>
                <strong><a href="{{ url_for('main.user_profile', username=comment.author.username) }}">{{ comment.author.username }}</a></strong>
            </div>
            <small class="comment-date">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
        </div>

        <div id="comment-view-{{ comment.id }}">
            <div class="comment-content">
                {{ comment.content }}
            </div>
        </div>

        <div id="comment-edit-{{ comment.id }}" style="display: none;">
            <form method="POST" action="{{ url_for('polls.edit_comment', comment_id=comment.id) }}" class="comment-edit-form">
                <textarea name="content" class="form-control" required>{{ comment.content }}</textarea>
                <button type="submit" class="btn btn-sm btn-primary">Save</button>
                <button type="button" class="btn btn-sm btn-light" onclick="toggleEdit({{ comment.id }})">Cancel</button>
            </form>
        </div>

        <div class="comment-actions">
            <form method="POST" action="{{ url_for('polls.react_comment', comment_id=comment.id) }}" style="display: inline;">
                <button type="submit" name="reaction" value="like" class="btn btn-sm btn-light">üëç {{ comment.get_likes_count() }}</button>
                <button type="submit" name="reaction" value="dislike" class="btn btn-sm btn-light">üëé {{ comment.get_dislikes_count() }}</button>
            </form>
            
            {% if comment.author == current_user %}
                <button class="btn btn-sm btn-secondary" onclick="toggleEdit({{ comment.id }})">Edit</button>

                <form method="POST" action="{{ url_for('polls.delete_comment', comment_id=comment.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </form>
            {% endif %}
        </div>
    </div> {% endif %} {% else %}
    <p class="no-comments">Still no comments. Be the first!</p>
    {% endfor %}
</div>
    </div>
</div>
<script>
    function toggleEdit(commentId){
        const viewDiv = document.getElementById('comment-view-' + commentId)
        const editDiv = document.getElementById('comment-edit-' + commentId)

        if (viewDiv.style.display === 'none') {
            viewDiv.style.display = 'block';
            editDiv.style.display = 'none';
        } else {
            viewDiv.style.display = 'none';
            editDiv.style.display = 'block';
        }
    }
</script>
{% endblock %}
